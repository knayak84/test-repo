name: Fast-Forward Merge on PR Approval (main only)
permissions: write-all
on:
  pull_request_review:
    types: [submitted, edited]

jobs:
  ff-merge:
    name: Fast-Forward Merge (main only, on approval)
    runs-on: ubuntu-latest

    # Only run when the review that triggered the event is an approval,
    # the PR targets main, and PR is not a draft.
    if: >
      github.event.review.state == 'approved' &&
      github.event.pull_request.base.ref == 'main' &&
      github.event.pull_request.draft == false

    steps:
      - name: Checkout repository (fetch all history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      - name: Confirm PR still looks approved (no outstanding change requests)
        id: check_reviews
        uses: actions/github-script@v6
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.pull_request.number;

            // List all reviews on the PR (paginated)
            const reviews = await github.rest.pulls.listReviews({
              owner,
              repo,
              pull_number: prNumber,
              per_page: 100
            }).then(r => r.data);

            if (!reviews || reviews.length === 0) {
              core.setFailed('No reviews found on this PR.');
              return;
            }

            // Keep only the latest review per user
            const latestByUser = {};
            for (const r of reviews) {
              // skip bots / null users defensively
              if (!r.user || !r.user.login) continue;
              latestByUser[r.user.login] = r;
            }

            const latestStates = Object.values(latestByUser).map(r => r.state);
            const approvals = latestStates.filter(s => s === 'APPROVED').length;
            const changesRequested = latestStates.filter(s => s === 'CHANGES_REQUESTED').length;

            core.info(`Approvals (latest per user): ${approvals}`);
            core.info(`Change requests (latest per user): ${changesRequested}`);

            if (changesRequested > 0) {
              core.setFailed('There is at least one outstanding "Changes requested" review. Cannot merge.');
              return;
            }

            if (approvals < 1) {
              core.setFailed('PR does not have any current APPROVED reviews (latest per user).');
              return;
            }

            // Pass metadata to later steps if needed
            return {approvals, changesRequested};

      - name: Attempt fast-forward merge
        run: |
          # Fetch the PR source branch tip
          git fetch origin ${{ github.event.pull_request.head.ref }}
          # Checkout the target (base) branch, usually main
          git switch ${{ github.event.pull_request.base.ref }}
          # Ensure it's synced with remote
          git reset --hard origin/${{ github.event.pull_request.base.ref }}
          # Try fast-forward merge
          git merge --ff-only FETCH_HEAD || {
            echo "Fast-forward merge failed. The PR branch cannot be fast-forward merged into main (probably needs rebase)."
            exit 1
          }

      - name: Push fast-forward to origin/main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Push the updated main (fast-forward only)
          git push origin main

      - name: Comment and close PR
        if: ${{ success() }}
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request.number;
            
            // Add comment
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr,
              body: "Merged to `main` via fast-forward on approval âœ…"
            });
            
            // Close the PR
            await github.rest.pulls.update({
              owner,
              repo,
              pull_number: pr,
              state: 'closed'
            });

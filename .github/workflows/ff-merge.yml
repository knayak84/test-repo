name: Fast-Forward Merge on PR Approval (main only)
permissions: write-all
on:
  pull_request_review:
    types: [submitted, edited]

jobs:
  ff-merge:
    name: Fast-Forward Merge (main only, on approval)
    runs-on: ubuntu-latest

    # Only run when the review that triggered the event is an approval,
    # the PR targets main, and PR is not a draft.
    if: >
      github.event.review.state == 'approved' &&
      github.event.pull_request.base.ref == 'main' &&
      github.event.pull_request.draft == false

    steps:
      - name: Wait for potential review changes (2 minutes)
        run: |
          echo "Waiting 2 minutes to allow reviewers to change their approval if needed..."
          sleep 120
          echo "Wait period complete. Proceeding with merge validation."

      - name: Checkout repository (fetch all history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      - name: Confirm PR still looks approved (no outstanding change requests)
        id: check_reviews
        uses: actions/github-script@v6
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.pull_request.number;

            // List all reviews on the PR (paginated)
            const reviews = await github.rest.pulls.listReviews({
              owner,
              repo,
              pull_number: prNumber,
              per_page: 100
            }).then(r => r.data);

            if (!reviews || reviews.length === 0) {
              core.setFailed('No reviews found on this PR.');
              return;
            }

            // Keep only the latest review per user
            const latestByUser = {};
            for (const r of reviews) {
              // skip bots / null users defensively
              if (!r.user || !r.user.login) continue;
              latestByUser[r.user.login] = r;
            }

            const latestStates = Object.values(latestByUser).map(r => r.state);
            const approvals = latestStates.filter(s => s === 'APPROVED').length;
            const changesRequested = latestStates.filter(s => s === 'CHANGES_REQUESTED').length;

            core.info(`Approvals (latest per user): ${approvals}`);
            core.info(`Change requests (latest per user): ${changesRequested}`);

            if (changesRequested > 0) {
              core.setFailed('There is at least one outstanding "Changes requested" review. Cannot merge.');
              return;
            }

            if (approvals < 1) {
              core.setFailed('PR does not have any current APPROVED reviews (latest per user).');
              return;
            }

            // Pass metadata to later steps if needed
            return {approvals, changesRequested};

      - name: Attempt fast-forward merge
        run: |
          # Fetch the PR source branch tip
          git fetch origin ${{ github.event.pull_request.head.ref }}
          # Checkout the target (base) branch, usually main
          git switch ${{ github.event.pull_request.base.ref }}
          # Ensure it's synced with remote
          git reset --hard origin/${{ github.event.pull_request.base.ref }}
          # Try fast-forward merge
          git merge --ff-only FETCH_HEAD || {
            echo "Fast-forward merge failed. The PR branch cannot be fast-forward merged into main (probably needs rebase)."
            exit 1
          }

      - name: Push fast-forward to origin/main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Push the updated main (fast-forward only)
          git push origin main

      - name: Close PR and add comment
        id: close_pr
        if: ${{ success() }}
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request.number;
            
            let prClosed = false;
            let commentAdded = false;
            let errorMessage = '';
            
            try {
              // Check if PR is closed (GitHub may auto-close when commits are pushed to base branch)
              let prData = await github.rest.pulls.get({
                owner,
                repo,
                pull_number: pr
              });
              
              // If PR is still open, wait 20 seconds for GitHub to auto-close it
              if (prData.data.state === 'open') {
                core.info('PR is still open, waiting 20 seconds for GitHub to auto-close...');
                await new Promise(resolve => setTimeout(resolve, 20000));
                
                // Check again if PR is closed
                prData = await github.rest.pulls.get({
                  owner,
                  repo,
                  pull_number: pr
                });
                
                // If still open after wait, manually close it
                if (prData.data.state === 'open') {
                  core.info('PR still open after wait, closing manually...');
                  await github.rest.pulls.update({
                    owner,
                    repo,
                    pull_number: pr,
                    state: 'closed'
                  });
                  core.info('PR closed successfully');
                  prClosed = true;
                } else {
                  core.info('PR was auto-closed by GitHub during wait period');
                  prClosed = true;
                }
              } else {
                core.info('PR is already closed');
                prClosed = true;
              }
              
              // Add comment to the closed PR
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pr,
                body: "Merged to `main` via fast-forward on approval ✅"
              });
              core.info('Comment added to PR');
              commentAdded = true;
              
            } catch (error) {
              errorMessage = error.message;
              core.setFailed(`Failed to close PR or add comment: ${error.message}`);
              throw error;
            }
            
            // Set outputs for summary step
            core.setOutput('pr_closed', prClosed);
            core.setOutput('comment_added', commentAdded);
            core.setOutput('error', errorMessage);

      - name: Workflow Summary
        if: always()
        run: |
          echo "## Fast-Forward Merge Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ **Status:** Workflow completed successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- ✅ Fast-forward merge completed" >> $GITHUB_STEP_SUMMARY
            echo "- ✅ Changes pushed to main" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.close_pr.outputs.pr_closed }}" == "true" ]; then
              echo "- ✅ PR closed" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ❌ PR could not be closed" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ "${{ steps.close_pr.outputs.comment_added }}" == "true" ]; then
              echo "- ✅ Comment added to PR" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ❌ Comment could not be added" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "❌ **Status:** Workflow failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Error:** ${{ steps.close_pr.outputs.error }}" >> $GITHUB_STEP_SUMMARY
          fi
